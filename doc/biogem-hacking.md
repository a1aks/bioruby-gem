# Hacking biogem

Biogem is a Ruby code generator for bioinformatics. It generates a plugin, in the
form of a gem, which is published automatically on both github and rubygems.org.

In this document we discuss the design of the biogem code generator, and ways to
hack it. Warning, this document is about Ruby meta-programming. Not for the faint of 
heart.

## Introduction

Biogem builds on [Jeweler](https://github.com/technicalpickles/jeweler).

jeweler comes with a library for managing and releasing RubyGem projects, and
a scaffold generator for starting new RubyGem projects. Using typical Ruby
overrides of jeweler methods, also known as meta-programming, Biogem subverts
Jeweler for our bioinformatics needs (see jeweler::Generator.new example below).

## Invoking the Biogem code generator

In the file ./bin/biogem rake, jeweler and bundler support are loaded and
Bio::Gem::Generator::Application invoked, which generates the new directory and
files. Thereafter biogem changes directory and runs some rake commands.

## Inside Bio::Gem::Generator::Application

First Jeweler::Generator.run is run, so the basic scaffolding exists for Rake,
tests etc. Nothing special so far. Where it gets interesting is that biogem
overrides Jeweler classes in [./lib/bio-gem/mod/jeweler.rb](https://github.com/helios/bioruby-gem/blob/master/lib/bio-gem/mod/jeweler.rb). In this file, at runtime,
Jeweler::Generator.new is replaced with our own version, which calls the
original first, but continues to plug in information. Any time jeweler::Generator.new is called,
our edition is called. Even from within jeweler!

It is important to check out this file, as many overrides are defined here.
Also have a look at the *create_files* function. That is where directories and
files are generated from templates.

## Biogem options

The application generator is programmed from biogem command line options. These
options are listed in [jeweler/options.rb](https://github.com/helios/bioruby-gem/blob/master/lib/bio-gem/mod/jeweler/options.rb).

## Biogem templates

Biogem templates are listed in [./lib/bio-gem/templates](https://github.com/helios/bioruby-gem/tree/master/lib/bio-gem/templates). These templates use erb to tune content within.

Templates are by in the jeweler.rb override (described above). For example the Rakefile is 
generated with

        output_template_in_target 'Rakefile'

it is all fairly straightforward. 

## Check out the jeweler source code

From the above you can see how we reprogram jeweler for our needs. To find new
ways of generating code, we strongly suggest to also check out the [jeweler
source code](https://github.com/technicalpickles/jeweler/tree/master/lib). The
jeweler code base is well thought out, and stable.

## Changing jeweler behaviour

Just as an example we are going to override code generated by Jeweler. Jeweler generates
a dependency for rcov, a Ruby code coverage analyzer. We are going to remove this dependency, 
without touching the Jeweler code base.

In the Jeweler source code tree rcov is used in two files:

        grep -r rcov *
        jeweler/generator.rb:      development_dependencies << ["rcov", ">= 0"]
        jeweler/templates/other_tasks.erb:RSpec::Core::RakeTask.new(:rcov) do |spec|
        jeweler/templates/other_tasks.erb:  spec.rcov = true
        jeweler/templates/other_tasks.erb:Micronaut::RakeTask.new(:rcov) do |examples|
        jeweler/templates/other_tasks.erb:  examples.rcov_opts = '-Ilib -I<%= test_dir %>'
        jeweler/templates/other_tasks.erb:  examples.rcov = true
        jeweler/templates/other_tasks.erb:require 'rcov/rcovtask'
        jeweler/templates/other_tasks.erb:  <%= test_task %>.rcov_opts << '--exclude "gems/*"'

The first step is to remove the rcov entry from development_dependencies. This can be
done by adding a line in Biogems lib/bio-gem/mod/jeweler.rb. Change it to 

        class Jeweler
          class Generator 
            alias original_initialize initialize
            def initialize(options = {})
              original_initialize(options)
              development_dependencies << ["bio", ">= 1.4.2"]
              development_dependencies.delete_if { |k,v| k == "rcov" }
              (...) 

You can see here that BioRuby support is always added. The next step is to change 
the behaviour of jeweler/templates/other_tasks.erb. The code to generate the
Rakefile lists is 

        <% case testing_framework %>
        <% when :rspec %>
          (...)
        <% when :micronaut %>
          (...)
        <% else %>
        require 'rcov/rcovtask'
        Rcov::RcovTask.new do |<%= test_task %>|
          (...)
        end
        <% end %>

and, annoyingly, shows that rcov is always added by default (in the final
'else'). We should communicate with the author of Jeweler to fix this. However, we
also have the option to override the Rakefile generator. The jeweler Rakefile
template has the form

        require 'rubygems'
        <%= render_template 'bundler_setup.erb' %>
        require 'rake'
        <%= render_template 'jeweler_tasks.erb' %>
        <%= render_template 'other_tasks.erb' %>

The two important functions in jeweler.rb are:

    def render_template(source)
      template_contents = File.read(File.join(template_dir, source))
      template          = ERB.new(template_contents, nil, '<>')
      # squish extraneous whitespace from some of the conditionals
      template.result(binding).gsub(/\n\n\n+/, "\n\n")
    end

    def output_template_in_target(source, destination = source)
      final_destination = File.join(target_dir, destination)
      template_result   = render_template(source)
      File.open(final_destination, 'w') {|file| file.write(template_result)}
      $stdout.puts "\tcreate\t#{destination}"
    end

these find the templates and render them through ERB. 

Naturally, Biogem has needed some overriding behaviour.  In this case Biogems jeweler.rb
has

    def output_template_in_target_generic_update(source, destination = source, template_dir = template_dir_biogem)
      final_destination = File.join(target_dir, destination)
      template_result   = render_template_generic(source, template_dir)
      File.open(final_destination, 'a') {|file| file.write(template_result)}
      $stdout.puts "\tcreate\t#{destination}"
    end    

and, in the case of the --with-db option, the Rakefile already gets modified by Biogem

    output_template_in_target_generic 'rakefile', 'Rakefile', template_dir_biogem

So, what would be the best route here, to change biogem behaviour? We have to rewrite
the Rakefile template to remove the rcov lines. We can 
change the *render_template* to allow rewriting the template. Unfortunately there is no
existing hook for that in jeweler. So, let us inject a hook named *after_render_template*
to a *render_template* override. First we open the Jeweler::Generator class and move the method to biogem jeweler.rb, renaming the original method to original_render_template:

        class Jeweler
          class Generator 
            alias original_render_template render_template
            def render_template(source)
              buf = original_render_template(source)
              # call hook (returns edited buf)
              after_render_template(source,buf)
            end

            # new hook for removing stuff
            def after_render_template(source,buf)
              if source == 'other_tasks.erb'
                # remove rcov related lines
                buf.gsub!(/require 'rcov/rcovtask'/,'')
                (...)
              end
            end

you probably get the gist (the stuff you can do with Ruby meta-programming!).
The solution chosen overrides original jeweler behaviour without touching
jeweler itself. Naturally, if it can be handled in jeweler, it is strongly
preferred.  With our solution a small change in jeweler may now break biogem
(in software engineering terms: the fix is brittle).

Still, for stuff that will not go into jeweler, this is a way of changing
behaviour.

## DRY (Do not repeat yourself)

This document should help you preventing repeating yourself. Code generation
can be very useful. When you have something that is useful to yourself, or
others, and is bioinformatics related, add it to biogem.  When it is more
generic, add it to jeweler. You may make a lot of people happy.

## More on meta-programming

The Pragmatic programmers book on [Ruby metaprogramming](http://www.amazon.com/Metaprogramming-Ruby-Program-Like-Pros/dp/1934356476/ref=cm_cr_pr_product_top) is recommended reading.

Copyright (C) 2012 Pjotr Prins <pjotr.prins@thebird.nl>
