# Hacking biogem

Biogem is a Ruby code generator for bioinformatics. It generates a plugin, in the
form of a gem, which is published automatically on both github and rubygems.org.

In this document we discuss the design of the biogem code generator, and ways to
hack it.

## Introduction

Biogem builds on [Jeweler](https://github.com/technicalpickles/jeweler).

Jeweller comes with a library for managing and releasing RubyGem projects, and
a scaffold generator for starting new RubyGem projects. Using typical Ruby
overrides of Jeweller methods, also known as meta-programming, Biogem subverts
Jeweler for our bioinformatics needs (see jeweler::Generator.new example below).

## Invoking the Biogem code generator

In the file ./bin/biogem rake, jeweler and bundler support are loaded and
Bio::Gem::Generator::Application invoked, which generates the new directory and
files. Thereafter biogem changes directory and runs some rake commands.

## Inside Bio::Gem::Generator::Application

First Jeweler::Generator.run is run, so the basic scaffolding exists for Rake,
tests etc. Nothing special so far. Where it gets interesting is that biogem
overrides Jeweler classes in [./lib/bio-gem/mod/jeweler.rb](https://github.com/helios/bioruby-gem/blob/master/lib/bio-gem/mod/jeweler.rb). In this file, at runtime,
Jeweler::Generator.new is replaced with our own version, which calls the
original first, but continues to plug in information. Any time jeweler::Generator.new is called,
our edition is called. Even from within Jeweller!

It is important to check out this file, as many overrides are defined here.
Also have a look at the *create_files* function. That is where directories and
files are generated from templates.

## Biogem options

The application generator is programmed from biogem command line options. These
options are listed in [jeweler/options.rb](https://github.com/helios/bioruby-gem/blob/master/lib/bio-gem/mod/jeweler/options.rb).

## Biogem templates

Biogem templates are listed in [./lib/bio-gem/templates](https://github.com/helios/bioruby-gem/tree/master/lib/bio-gem/templates). These templates use erb to tune content within.

Templates are by in the jeweler.rb override (described above). For example the Rakefile is 
generated with

        output_template_in_target 'Rakefile'

it is all fairly straightforward. 

## Check out the jeweler source code

From the above you can see how we reprogram Jeweller for our needs. To find new
ways of generating code, we strongly suggest to also check out the [jeweller
source code](https://github.com/technicalpickles/jeweler/tree/master/lib). The
Jeweller code base is well thought out, and stable.

## Changing jeweler behaviour

Just as an example we are going to override code generated by Jeweler. Jeweler generates
a dependency for rcov, a Ruby code coverage analyzer. We are going to remove this dependency, 
without touching the Jeweler code base.

In the Jeweler source code tree rcov is used in two files:

        grep -r rcov *
        jeweler/generator.rb:      development_dependencies << ["rcov", ">= 0"]
        jeweler/templates/other_tasks.erb:RSpec::Core::RakeTask.new(:rcov) do |spec|
        jeweler/templates/other_tasks.erb:  spec.rcov = true
        jeweler/templates/other_tasks.erb:Micronaut::RakeTask.new(:rcov) do |examples|
        jeweler/templates/other_tasks.erb:  examples.rcov_opts = '-Ilib -I<%= test_dir %>'
        jeweler/templates/other_tasks.erb:  examples.rcov = true
        jeweler/templates/other_tasks.erb:require 'rcov/rcovtask'
        jeweler/templates/other_tasks.erb:  <%= test_task %>.rcov_opts << '--exclude "gems/*"'

The first step is to remove the rcov entry from development_dependencies. This can be
done by adding a line in Biogems lib/bio-gem/mod/jeweler.rb

## DRY (Do not repeat yourself)

This document should help you preventing repeating yourself. Code generation
can be very useful. When you have something bioinformatics, add it to biogem.
When it is more generic, add it to Jeweller. That will make a lot of people
happy.





